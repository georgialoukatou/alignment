---
title: "Smoothing or whatever"
author: "Gabe & Jake"
date: "Friday, August 07, 2015"
output: pdf_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
options(warn=-1)
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(bit64))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(ggplot2))

if (getwd()=="C:/stuff/stanford") {
  setwd("C:/stuff/stanford/alignment")
}
suppressMessages(df <- fread('alignment/debug/shuffled/TTTTTTTT1.csv', header=T))
df$shuffled <- 'unshuffled'
suppressMessages(tdf <- fread('alignment/debug/shuffled/TTTTTTTT.csv', header=T))
tdf$shuffled <- 'shuffled'
suppressMessages(t2df <- fread('alignment/debug/shuffled/TTTTTTTT2.csv', header=T))
t2df$shuffled <- 'shuffled2'
df <- rbind(df,tdf, t2df)

d <- df[,list(ba=ba,nba=nba,bna=bna,nbna=nbna,
              vspeak=verifiedSpeaker,vreply=verifiedReplier,
              sid=speakerId,rid=replierId,category=category,
              pyalign=alignment,dnm=dnmalignment,shuffled=shuffled),]
options(warn=0)

cutoff <- 2
```

```{r}
smoothalign <- function(df,sm,align="logodds") {
  if (align=="logodds") {
    return(log(df$ba+sm)-log(df$ba+df$nba+2*sm)-log(df$bna+sm)+log(df$bna+df$nbna+2*sm))
  } else if (align=="subodds") {
    return((df$ba+sm)/(df$ba+df$nba+2*sm)-(df$bna+sm)/(df$bna+df$nbna+2*sm))
  } else if (align=="logdnm") {
    return(log(df$ba+sm)-log(df$ba+df$nba+2*sm)-log(df$bna+df$ba+sm)+log(df$nba+df$ba+df$bna+df$nbna+2*sm))
  } else if (align=="subdnm") {
    return((df$ba+sm)/(df$ba+df$nba+2*sm)-(df$bna+df$ba+sm)/(df$nba+df$ba+df$bna+df$nbna+2*sm))
  } else {
    stop("Invalid alignment type.")
  }
} 

d$lo1 <- smoothalign(d,1,"logodds")
d$sd0 <- smoothalign(d,0,"subdnm")

stopifnot(max(abs(d$lo1-d$pyalign))<.00001)
stopifnot(max(abs(d$sd0-d$dnm))<.00001)

cutoff <- 5

```

```{r}
pasmooth <- function(df,alpha=2,align="logodds") {
  pa = (df$ba+df$nba)/(df$ba+df$nba+df$bna+df$nbna)
  if (align=="logodds") {
    return(log(df$ba+alpha*pa)-log(df$ba+df$nba+alpha)-log(df$bna+alpha*(1-pa))+log(df$bna+df$nbna+alpha))
  } else if (align=="subdnm") {
    return((df$ba+alpha*pa)/(df$ba+df$nba+alpha)-(df$bna+df$ba+alpha*pa)/(df$nba+df$ba+df$bna+df$nbna+alpha))
  } else {
    stop("Invalid alignment type.")
  }
} 

d$pa1 <- pasmooth(d,1,"logodds")
```

```{r}
addsmooth <- function(df,alpha,align="logodds") {
  pa = (df$ba+df$nba)/(df$ba+df$nba+df$bna+df$nbna)
  if (align=="logodds") {
    return(log((df$ba)/(df$ba+df$nba)+alpha)-log((df$bna)/(df$bna+df$nbna)+alpha))
  } else if (align=="subdnm") {
    return((df$ba)/(df$ba+df$nba)-(df$bna+df$ba)/(df$nba+df$ba+df$bna+df$nbna))
  } else {
    stop("Invalid alignment type.")
  }
} 

d$ad1 <- addsmooth(d,.1,"logodds")
```

```{r}
d2 <- d %>%
  filter((ba+nba)>=cutoff,(bna+nbna)>=cutoff) %>%
  group_by(category,shuffled) %>%
  summarize(convs=n(),OurSmooth=mean(lo1),PASmooth=mean(pa1),AddSmooth=mean(ad1),DNM=mean(sd0))%>%
  gather(alignment,mean,OurSmooth,PASmooth,AddSmooth,DNM)

ggplot(d2,aes(x=1,y=mean,color=convs,label=category)) + geom_violin() + geom_text(position=position_jitter(w=0.2),size=4) + stat_summary(geom="point",fun.y="mean") + labs(title=paste("By-marker aggregated alignment (Cutoff=",cutoff,")",sep=''),x="Test run number",y="Mean alignment",color="Speaker-replier\npairs using\nthe marker") + facet_grid(alignment~shuffled,scales="free") + geom_hline(yintercept=0) + theme_grey() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

```

```{r}
d2 <- d %>%
  filter((ba+nba)>=cutoff,(bna+nbna)>=cutoff) %>%
  mutate(OurSmooth=lo1,PASmooth=pa1,AddSmooth=ad1,DNM=sd0)%>%
  gather(alignment,mean,OurSmooth,PASmooth,AddSmooth,DNM)


ggplot(d2,aes(x=paste(vspeak,vreply,sep="\n"),y=mean,label=category)) + geom_violin() + stat_summary(geom="point",fun.y="mean") + labs(title=paste("Alignments over all\nspeaker-replier-marker triplets (Cutoff=",cutoff,")",sep=''),x="Speaker/replier verification",y="Mean alignment",color="Speaker-replier\npairs using\nthe marker") + facet_grid(alignment~shuffled,scales="free") + theme_grey()
```

```{r}
d2 <- d %>%
  filter((ba+nba)>=cutoff,(bna+nbna)>=cutoff) %>%
  group_by(vspeak,vreply,category,shuffled) %>%
  summarize(prop=mean((2*ba+nba+bna)/(2*(ba+nba+bna+nbna))),OurSmooth=mean(lo1),PASmooth=mean(pa1),AddSmooth=mean(ad1),DNM=mean(sd0))%>%
  gather(alignment,mean,OurSmooth,PASmooth,AddSmooth,DNM)

ggplot(d2,aes(x=prop,y=mean,color=paste(vspeak,vreply))) + geom_point() +geom_smooth(method='lm') + labs(title=paste("By-marker aggregated alignment\nagainst frequency (Cutoff=",cutoff,")",sep=''),x="Marker frequency",y="Mean alignment",color="Speaker/replier\nverification") + facet_grid(alignment~shuffled,scales="free") + theme_bw()
```


```{r}
d2 <- d %>%
  filter((ba+nba)>=cutoff,(bna+nbna)>=cutoff) %>%
  group_by(vspeak,vreply,category,shuffled) %>%
  summarize(prop=mean((2*ba+nba+bna)/(2*(ba+nba+bna+nbna))),OurSmooth=mean(lo1),PASmooth=mean(pa1),AddSmooth=mean(ad1),DNM=mean(sd0))%>%
  gather(alignment,mean,OurSmooth,PASmooth,AddSmooth,DNM)

d3 <- inner_join(d2[shuffled=='shuffled',],d2[shuffled=='unshuffled'],by=c('vspeak','vreply','category','alignment')) %>%
  mutate(diff=mean.y-mean.x,prop=(prop.x+prop.y)/2)

ggplot(d3,aes(x=prop,y=diff,color=paste(vspeak,vreply))) + geom_point() +geom_smooth(method='lm') + labs(title=paste("By-marker aggregated alignment\nagainst frequency (Cutoff=",cutoff,")",sep=''),x="Marker frequency",y="Mean alignment",color="Speaker/replier\nverification") + facet_grid(~alignment,scales="free") + theme_bw()
```


```{r}
d2 <- d %>%
  filter((ba+nba)>=cutoff,(bna+nbna)>=cutoff) %>%
  group_by(category,shuffled) %>%
  summarize(convs=n(),OurSmooth=mean(lo1),PASmooth=mean(pa1),AddSmooth=mean(ad1),DNM=mean(sd0))%>%
  gather(alignment,mean,OurSmooth,PASmooth,AddSmooth,DNM)

d3 <- inner_join(d2[shuffled=='shuffled',],d2[shuffled=='unshuffled'],by=c('category','alignment')) %>%
  mutate(mean=mean.y-mean.x,convs=(convs.x+convs.y)/2)

ggplot(d3,aes(x=1,y=mean,color=convs,label=category)) + geom_violin() + geom_text(position=position_jitter(w=0.2),size=4) + stat_summary(geom="point",fun.y="mean") + labs(title=paste("By-marker aggregated alignment (Cutoff=",cutoff,")",sep=''),x="Test run number",y="Mean alignment",color="Speaker-replier\npairs using\nthe marker") + facet_grid(~alignment,scales="free") + geom_hline(yintercept=0) + theme_grey() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

```

```{r}
d2 <- d %>%
  filter((ba+nba)>=cutoff,(bna+nbna)>=cutoff) %>%
  mutate(OurSmooth=lo1,PASmooth=pa1,AddSmooth=ad1,DNM=sd0)%>%
  gather(alignment,mean,OurSmooth,PASmooth,AddSmooth,DNM) %>%
  select(alignment,mean,vspeak,vreply,category,shuffled)

d3 <- inner_join(d2[shuffled=='shuffled',],d2[shuffled=='unshuffled'],by=c('vspeak','vreply','category','alignment')) %>%
  mutate(mean=mean.y-mean.x)


ggplot(d3,aes(x=paste(vspeak,vreply,sep="\n"),y=mean,label=category)) + geom_violin() + stat_summary(geom="point",fun.y="mean") + labs(title=paste("Alignments over all\nspeaker-replier-marker triplets (Cutoff=",cutoff,")",sep=''),x="Speaker/replier verification",y="Mean alignment",color="Speaker-replier\npairs using\nthe marker") + facet_grid(alignment~shuffled,scales="free") + theme_grey()
```
