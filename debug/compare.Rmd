---
title: "DNM vs Alignment Comparison"
author: "Jake Prasad"
date: "Tuesday, July 28, 2015"
output: pdf_document
---



```{r,echo=FALSE}
# Loading the most recent results.
library(data.table)
library(bit64)
library(dplyr)
library(ggplot2)
library(tidyr)

df <- fread('results.csv', header=T)
```



```{r, echo=FALSE}
# Cleaning down the data table:
d <- df[,list(ba=ba,nba=nba,bna=bna,nbna=nbna,
              vspeak=verifiedSpeaker,vreply=verifiedReplier,
              sid=speakerId,rid=replierId,category=category,
              pyalign=alignment,percentDiff=percentDiff),]

```


```{r, echo=FALSE}
# Calculating alignments in R to check against the python alignments; stop if the summary has a max absolute difference greater than 1e-05

smoothalign <- function(df,sm) {
  return(log(df$ba+sm)-log(df$ba+df$nba+2*sm)-log(df$bna+sm)+log(df$bna+df$nbna+2*sm))
} 

smoothalignold <- function(df,sm) {
  return((df$ba+sm)/(df$ba+df$nba+2*sm)-(df$bna+df$ba+sm)/(df$nba+df$ba+df$bna+df$nbna+2*sm))
}

d$sm0 <- smoothalign(d,0)
d$sm1 <- smoothalign(d,1)
d$osm0 <- smoothalignold(d,0)

#max(abs(d$sm1-d$pyalign))

```

Alignment (Verified/NonVerified):

Our standard measure for alignment uses Verified/Not verified as a power proxy. Using Verified/Not verified, we're able to clearly see that an influential speaker/uninfluential replier pair results in a stronger alignment than an uninfluential speaker/influential replier pair.

```{r}
subsetted <- subset(df,logdnmalignment!="FALSE"&(ba+nba)>5&(bna+nbna)>5)
subsetted = transform(subsetted,logdnmalignment=as.numeric(logdnmalignment))
d2 <- subsetted %>%
  group_by(verifiedSpeaker,speakerId,replierId) %>%
  summarize(convs=n(), alignment=alignment, vreply=verifiedReplier, dnmalignment=dnmalignment, noLogAlign=noLogAlign, logdnmalignment=logdnmalignment) %>%
  gather(alignmentType,alignmentValue,c(alignment, dnmalignment, logdnmalignment, noLogAlign))

levels(d2$alignmentType)=c("alignment","noLogAlign","logdnmalignment","dnmalignment")

ggplot(d2,aes(x=paste(verifiedSpeaker,vreply),y=alignmentValue)) + geom_violin() + labs(title="Log-Comparison of Different Alignment Formulas",x="Speaker verified?",y="Alignment") + facet_wrap(~ alignmentType, scales = "free") + stat_summary(geom="point",fun.y="mean")

```
Follower Bins:

The Echoes Of Power paper used follower count as a power proxy. If follower count isn't a good power proxy it could explain why alignment wasn't found. We bin follower counts for speaker and repliers and plot the results.

```{r}
d2 <- subset(df,logdnmalignment!="FALSE"&(ba+nba)>5&(bna+nbna)>5)
d2$speakerBins <- cut(d2$speakerFollowers, breaks=c(0,1000, 10000, 100000, 100000000), labels=c("Speaker Count < 10^3", "Speaker Count < 10^4", "Speaker Count < 10^5", "Speaker Count > 10^5"))
d2$replierBins <- cut(d2$replierFollowers, breaks=c(0,1000, 10000, 100000, 100000000), labels=c("< 10^3", "< 10^4", "< 10^5", "> 10^5"))
ggplot(d2,aes(x=paste(speakerBins),y=alignment)) + geom_violin() + labs(font=10, title="Speaker/Replier Follower Count (Absolute values)",x="Replier Follower Count",y="Alignment") + facet_wrap(~ replierBins) + geom_boxplot(width=.1) 


```

This is an interesting plot. It appears that follower count does have an effect on alignment. Let's also try plotting the percent difference between speaker follower count and replier follower count.

```{r}
d2 <- subset(df,logdnmalignment!="FALSE"&(ba+nba)>5&(bna+nbna)>5)
subsetted = transform(subsetted,logdnmalignment=as.numeric(logdnmalignment))
d2 <- subsetted %>%
  group_by(verifiedSpeaker,speakerId,replierId) %>%
  summarize(convs=n(), alignment=alignment, vreply=verifiedReplier, dnmalignment=dnmalignment, noLogAlign=noLogAlign, logdnmalignment=logdnmalignment, percentDiff=percentDiff) %>%
  gather(alignmentType,alignmentValue,c(alignment, dnmalignment, logdnmalignment, noLogAlign))

d2$followerBins <- cut(d2$percentDiff, breaks=c(0,0.1,0.5,0.9, 0.99, 0.999, 1), labels=c("<0.1","<0.5", "<0.9", "<0.99", "<0.999", "<1"))
 
levels(d2$alignmentType)=c("alignment","noLogAlign","logdnmalignment","dnmalignment")

ggplot(d2,aes(x=followerBins,y=alignmentValue)) + geom_violin() + labs(title="Speaker/Replier Follower Count Percent Difference",x="Percent Difference between Speaker Follower Count and Replier Follower Count",y="Alignment") + facet_wrap(~ alignmentType, scales = "free") + geom_boxplot(width=.1) 
```

