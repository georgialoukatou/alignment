---
title: "DNM vs Alignment Comparison"
author: "Jake Prasad"
date: "Tuesday, July 28, 2015"
output: pdf_document
---



```{r,echo=FALSE}
# Loading the most recent results.
library(data.table)
library(bit64)
library(dplyr)
library(ggplot2)
library(tidyr)

df <- fread('results.csv', header=T)
```



```{r, echo=FALSE}
# Cleaning down the data table:
d <- df[,list(ba=ba,nba=nba,bna=bna,nbna=nbna,
              vspeak=verifiedSpeaker,vreply=verifiedReplier,
              sid=speakerId,rid=replierId,category=category,
              pyalign=alignment,reciprocity=reciprocity,numUtterances=numUtterances, msgSentiment=msgSentiment, replySentiment=replySentiment),]

```


```{r}
smoothalign <- function(df,sm,align="logodds") {
  if (align=="logodds") {
    return(log(df$ba+sm)-log(df$ba+df$nba+2*sm)-log(df$bna+sm)+log(df$bna+df$nbna+2*sm))
  } else if (align=="subodds") {
    return((df$ba+sm)/(df$ba+df$nba+2*sm)-(df$bna+sm)/(df$bna+df$nbna+2*sm))
  } else if (align=="logdnm") {
    return(log(df$ba+sm)-log(df$ba+df$nba+2*sm)-log(df$bna+df$ba+sm)+log(df$nba+df$ba+df$bna+df$nbna+2*sm))
  } else if (align=="subdnm") {
    return((df$ba+sm)/(df$ba+df$nba+2*sm)-(df$bna+df$ba+sm)/(df$nba+df$ba+df$bna+df$nbna+2*sm))
  } else {
    stop("Invalid alignment type.")
  }
} 

d$lo1 <- smoothalign(d,1,"logodds")
d$sd0 <- smoothalign(d,0,"subdnm")

stopifnot(max(abs(d$lo1-d$pyalign))<.00001)
#stopifnot(max(abs(d$sd0-d$dnm))<.00001)


```

Alignment (Verified/NonVerified):

Our standard measure for alignment uses Verified/Not verified as a power proxy. Using Verified/Not verified, we're able to clearly see that an influential speaker/uninfluential replier pair results in a stronger alignment than an uninfluential speaker/influential replier pair.

```{r}
subsetted <- subset(df,logdnmalignment!="FALSE"&(ba+nba)>5&(bna+nbna)>5)
subsetted = transform(subsetted,logdnmalignment=as.numeric(logdnmalignment))
d2 <- subsetted %>%
  group_by(verifiedSpeaker,speakerId,replierId) %>%
  summarize(convs=n(), alignment=alignment, vreply=verifiedReplier, dnmalignment=dnmalignment, noLogAlign=noLogAlign, logdnmalignment=logdnmalignment) %>%
  gather(alignmentType,alignmentValue,c(alignment, dnmalignment, logdnmalignment, noLogAlign))

levels(d2$alignmentType)=c("alignment","noLogAlign","logdnmalignment","dnmalignment")

ggplot(d2,aes(x=paste(verifiedSpeaker,vreply),y=alignmentValue)) + geom_violin() + labs(title="Log-Comparison of Different Alignment Formulas",x="Speaker verified?",y="Alignment") + facet_wrap(~ alignmentType, scales = "free") + stat_summary(geom="point",fun.y="mean")

```
Follower Bins:

The Echoes Of Power paper used follower count as a power proxy. If follower count isn't a good power proxy it could explain why alignment wasn't found. We bin follower counts for speaker and repliers and plot the results.

```{r}
d2 <- subset(df,logdnmalignment!="FALSE"&(ba+nba)>5&(bna+nbna)>5)
d2$speakerBins <- cut(d2$speakerFollowers, breaks=c(0,1000, 10000, 100000, 100000000), labels=c("Speaker Count < 10^3", "Speaker Count < 10^4", "Speaker Count < 10^5", "Speaker Count > 10^5"))
d2$replierBins <- cut(d2$replierFollowers, breaks=c(0,1000, 10000, 100000, 100000000), labels=c("< 10^3", "< 10^4", "< 10^5", "> 10^5"))
ggplot(d2,aes(x=paste(speakerBins),y=alignment)) + geom_violin() + labs(font=10, title="Speaker/Replier Follower Count (Absolute values)",x="Speaker Follower Count",y="Alignment") + facet_wrap(~ replierBins) + geom_boxplot(width=.1) 


```

This is an interesting plot. It appears that follower count does have an effect on alignment. Let's also try plotting the percent difference between speaker follower count and replier follower count.

```{r}
d2 <- subset(df,logdnmalignment!="FALSE"&(ba+nba)>5&(bna+nbna)>5)
subsetted <- transform(d2,logdnmalignment=as.numeric(logdnmalignment))
d2 <- subsetted %>%
  group_by(verifiedSpeaker,speakerId,replierId) %>%
  summarize(convs=n(), alignment=alignment, vreply=verifiedReplier, dnmalignment=dnmalignment, noLogAlign=noLogAlign, logdnmalignment=logdnmalignment, percentDiff=percentDiff) %>%
  gather(alignmentType,alignmentValue,c(alignment, dnmalignment, logdnmalignment, noLogAlign))

d2$followerBins <- cut(d2$percentDiff, breaks=c(0,0.1,0.5,0.9, 0.99, 0.999, 1), labels=c("<0.1","<0.5", "<0.9", "<0.99", "<0.999", "<1"))
 
levels(d2$alignmentType)=c("alignment","noLogAlign","logdnmalignment","dnmalignment")

ggplot(d2,aes(x=followerBins,y=alignmentValue)) + geom_violin() + labs(title="Speaker/Replier Follower Count Percent Difference",x="Percent Difference between Speaker Follower Count and Replier Follower Count",y="Alignment") + facet_wrap(~ alignmentType, scales = "free") + geom_boxplot(width=.1) 
```

This is also interesting. It appears like alignment could follow a parabolic curve insteaed of a linear one. Let's also look at alignment by marker

```{r}
d2 <- d %>%
  filter(vreply==F,(ba+nba)>=5,(bna+nbna)>=5) %>%
  group_by(vspeak,category) %>%
  #filter(convs<50) %>%
  summarize(convs=n(),Ours=mean(lo1),DNM=mean(sd0)) %>%
  gather(alignment,mean,Ours,DNM)

ggplot(d2,aes(x=vspeak,y=mean,color=convs,label=category)) + geom_violin() + geom_text(position=position_jitter(w=0.2),size=4) + labs(title="Non-verified repliers' alignments\naggregated by marker (Cutoff=5)",x="Speaker verification",y="Mean alignment",color="Speaker-replier\npairs using\nthe marker") + facet_wrap(~ alignment,scales="free") + theme_grey()

```

Hmm, from the given plot, it seems the DNM formula is prone to outliers among individual markers. Why might this be the case? First we pot alignment values against number of conversations to make sure our intuition is correct



```{r}
subsetted <- subset(d2)
ggplot(subsetted,aes(x=convs,y=mean,size=convs,color=convs,label=category)) + geom_point() + facet_wrap(~alignment, scales="free") + labs(y="Alignment",x="# of Convos per Marker") + geom_smooth(method=lm)

```

This is surprising. It appears that OUR formula is actually the one that's prone to outliers. Let's see if we can correct this

```{r}
subsetted <- subset(d2) %>%
  filter(convs<50)

ggplot(subsetted,aes(x=convs,y=mean,size=convs,color=convs,label=category)) + geom_point() + facet_wrap(~alignment, scales="free") + labs(y="Alignment",x="# of Convos per Marker") + geom_smooth(method=lm)

```

Ok, so it seems that markers with convs < 50 don't correspond to number of conversations. Let's replot the markers vs. alignment chart taking this new knowledge into account:

```{r}
d2 <- d %>%
  filter((ba+nba)>=5&(bna+nbna)>=5) %>%
  group_by(vspeak,category) %>%
  
  summarize(convs=n(),Ours=mean(lo1),DNM=mean(sd0)) %>%
  filter(convs<50) %>%
  gather(alignment,mean,Ours,DNM)

ggplot(d2,aes(x=vspeak,y=mean,color=convs,label=category)) + geom_violin() + geom_text(position=position_jitter(w=0.2),size=4) + labs(title="Non-verified repliers' alignments\naggregated by marker (Cutoff=5)",x="Speaker verification",y="Mean alignment",color="Speaker-replier\npairs using\nthe marker") + facet_wrap(~ alignment,scales="free") + theme_grey()

```

Ok, we got rid of the error with love. It's still surprising that we're seeing so many outliers. There's also a correspondence with utterances and alignment. Let's see if that effect's still exists witht he newly added convs<50 filter.

```{r}
d2 <- d %>%
  filter((ba+nba)>5&(bna+nbna)>5) %>%
  group_by(category) %>%
  summarize(utterances=mean(numUtterances),convs=n(),Ours=mean(lo1),DNM=mean(sd0),thresh=n()<50) %>%
  gather(alignment,mean,Ours,DNM)

ggplot(d2,aes(x=utterances,y=mean))+geom_point() + facet_wrap(alignment~thresh,scales="free") + geom_smooth(method=lm)
```

Ok, we're definitely decreasing our alignment to utterances correlation by filtering out convos < 50. However, we still see a slight correlation to # of utterances. Let's try to filter by # of utterances and # of convos this time.

```{r}
d2 <- d %>%
  filter((ba+nba)>5&(bna+nbna)>5) %>%
  group_by(category) %>%
  summarize(utterances=mean(ba+nbna+bna+nba),convs=n(),Ours=mean(lo1),DNM=mean(sd0),thresh=n()<50&mean(ba+nbna+bna+nba)<300,vreply=vreply,vspeaker=vspeak,base=(bna+1)/(2+bna+nbna),power=(1+ba)/(2+ba+nba)) %>%
  gather(alignment,mean,Ours,DNM) %>%
  filter(alignment=="Ours")

ggplot(d2,aes(x=utterances,y=mean))+geom_point() + facet_wrap(vspeaker~vreply,scales="free") + geom_smooth(method=lm)

```

Ok, so there's no way to filter out by # of utterances. This is ok though, as it means that words that are used less are more have more of an impact on alignment. As a final check, since it appears base probability is the defining measure of alignment, let's take a look at verified vs unverified speakers in a plot of base probability vs alignment:

```{r}
d2 <- d %>%
  filter((ba+nba)>5&(bna+nbna)>5) %>%
  group_by(category) %>%
  summarize(utterances=mean(ba+nbna+bna+nba),convs=n(),Ours=mean(lo1),DNM=mean(sd0),thresh=n()<50&mean(ba+nbna+bna+nba)<300,vreply=vreply,vspeaker=vspeak,base=(bna+1)/(2+bna+nbna),power=(1+ba)/(2+ba+nba)) %>%
  gather(alignment,mean,Ours,DNM) %>%
  filter(alignment=="Ours")
ggplot(d2, aes(x=base,y=mean)) + geom_point() + facet_wrap(vspeaker~vreply,scales="free") + geom_smooth(method=lm)

```

Great! It appears that in general, power has a larger effect on alignment than base probability.

Let's check DNM too:

```{r}
d2 <- d %>%
  filter((ba+nba)>5&(bna+nbna)>5) %>%
  group_by(category) %>%
  summarize(utterances=mean(ba+nbna+bna+nba),convs=n(),Ours=mean(lo1),DNM=mean(sd0),thresh=n()<50&mean(ba+nbna+bna+nba)<300,vreply=vreply,vspeaker=vspeak,base=(bna+1)/(2+bna+nbna),power=(1+ba)/(2+ba+nba)) %>%
  gather(alignment,mean,Ours,DNM) %>%
  filter(alignment=="DNM")
ggplot(d2, aes(x=base,y=mean)) + geom_point() + facet_wrap(vspeaker~vreply,scales="free") + geom_smooth(method=lm)

```
Ok, so base probability doesn't really have an effect on alignment in DNM.

Let's try plotting marker frequency against alignment:

```{r}
d2 <- d %>%
  filter((ba+nba)>5&(bna+nbna)>5) %>%
  group_by(category) %>%
  summarize(ba=sum(ba), nbna=sum(nbna), bna=sum(bna), nba=sum(nba), utterances=mean(ba+nbna+bna+nba),convs=n(),Ours=mean(lo1),DNM=mean(sd0),vreply=vreply,vspeaker=vspeak,category=category) %>%
  summarize(markerFreq=(2*ba+nba + bna)/(2*utterances), category=category, alignment=Ours)
ggplot(d2, aes(x=markerFreq,y=alignment)) + geom_point() + geom_smooth(method=lm)
```

```{r}
d2 <- d %>%
  filter((ba+nba)>5&(bna+nbna)>5) %>%
  group_by(category) %>%
  summarize(ba=sum(ba), nbna=sum(nbna), bna=sum(bna), nba=sum(nba), utterances=mean(ba+nbna+bna+nba),convs=n(),Ours=mean(lo1),DNM=mean(sd0),vreply=vreply,vspeaker=vspeak,category=category) %>%
  filter(utterances > 300) %>%
  summarize(markerFreq=(2*ba+nba + bna)/(2*utterances), category=category, alignment=Ours)
ggplot(d2, aes(x=markerFreq,y=alignment)) + geom_point() + geom_smooth(method=lm)
```
