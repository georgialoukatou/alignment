---
title: "extras"
author: "Gabe and Jake"
date: "Tuesday, July 28, 2015"
output: pdf_document
---


```{r,echo=FALSE}
# Loading the most recent results.
library(data.table)
library(bit64)
library(dplyr)
library(ggplot2)
library(tidyr)

df <- fread('shuffled/results.csv', header=T)
```



```{r, echo=FALSE}
# Cleaning down the data table:
d <- df[,list(ba=ba,nba=nba,bna=bna,nbna=nbna,
              vspeak=verifiedSpeaker,vreply=verifiedReplier,
              sid=speakerId,rid=replierId,category=category,
              pyalign=alignment,reciprocity=reciprocity,numUtterances=numUtterances, msgSentiment=(msgSentiment>0), replySentiment=(replySentiment>0)),]

```


```{r}
smoothalign <- function(df,sm,align="logodds") {
  if (align=="logodds") {
    return(log(df$ba+sm)-log(df$ba+df$nba+2*sm)-log(df$bna+sm)+log(df$bna+df$nbna+2*sm))
  } else if (align=="subodds") {
    return((df$ba+sm)/(df$ba+df$nba+2*sm)-(df$bna+sm)/(df$bna+df$nbna+2*sm))
  } else if (align=="logdnm") {
    return(log(df$ba+sm)-log(df$ba+df$nba+2*sm)-log(df$bna+df$ba+sm)+log(df$nba+df$ba+df$bna+df$nbna+2*sm))
  } else if (align=="subdnm") {
    return((df$ba+sm)/(df$ba+df$nba+2*sm)-(df$bna+df$ba+sm)/(df$nba+df$ba+df$bna+df$nbna+2*sm))
  } else {
    stop("Invalid alignment type.")
  }
} 

d$lo1 <- smoothalign(d,1,"logodds")
d$sd0 <- smoothalign(d,0,"subdnm")

stopifnot(max(abs(d$lo1-d$pyalign))<.00001)
#stopifnot(max(abs(d$sd0-d$dnm))<.00001)


```

***Reciprocity***

```{r}
library(dplyr)
library(ggplot2)

theme_set(theme_grey())

d2 <- d %>%
  filter((ba+nba)>=5&(bna+nbna)>=5) %>%
  group_by(vspeak,category, vreply, reciprocity) %>%
  summarize(convs=n(),alignment=mean(lo1), reciprocity=reciprocity)

ggplot(d2,aes(x=reciprocity,y=alignment)) + geom_violin()


```
Hmm, from the looks of the plot, it like reciprocity does have impact on alignment

Let's do a t-test

```{r}

t.test(d2$alignment~d2$reciprocity)

```

Interesting..., The t-test gives us a p-value of 0.6, so there isn't much of an impact.


***Sentiment***

```{r}
library(dplyr)
library(ggplot2)

theme_set(theme_grey())

d2 <- d %>%
  filter((ba+nba)>=5&(bna+nbna)>=5) %>%
  group_by(rid, sid, vreply, vspeak, msgSentiment, replySentiment) %>%
  summarize(convs=n(),mean=mean(pyalign))

ggplot(d2,aes(x=paste(msgSentiment,replySentiment),y=mean)) + geom_violin() + facet_wrap(vspeak~vreply) + labs(title="msgSentiment vs replySentiment") + stat_summary(geom="point", fun.y="mean")
```

Clearly, there's an impact of sentiment on alignment. Let's do a t-test

```{r}

d2 <- d %>%
  filter((ba+nba)>5&(bna+nbna)>5) %>%
  group_by(vspeak, vreply, category) %>%
  summarize(convs=n(),mean=mean(lo1), msgSentiment=(mean(msgSentiment)>0), replySentiment=(mean(replySentiment)>0))

t.test(d2$mean~d2$msgSentiment)

t.test(d2$mean~d2$replySentiment)

```

Let's also do some manual checking of means and sparsity:

```{r}
mean(filter(d2, msgSentiment==TRUE&replySentiment==TRUE)$mean)
nrow(filter(d2, msgSentiment==TRUE&replySentiment==TRUE))

mean(filter(d2, msgSentiment==TRUE&replySentiment==FALSE)$mean)
nrow(filter(d2, msgSentiment==TRUE&replySentiment==FALSE))

mean(filter(d2, msgSentiment==FALSE&replySentiment==TRUE)$mean)
nrow(filter(d2, msgSentiment==FALSE&replySentiment==TRUE))

mean(filter(d2, msgSentiment==FALSE&replySentiment==FALSE)$mean)
nrow(filter(d2, msgSentiment==FALSE&replySentiment==FALSE))

```

Ok, so maybe it's an aggregation issue?

*** Shuffling ***

Let's shuffle replies and replyUserIds

```{r}

df <- fread('shuffled/TTTTTTTT.csv', header=T)
df <- fread('shuffled/TTTTFTTT.csv', header=T) # Unshuffle verified speaker
df <- fread('shuffled/FFFFFFFF.csv', header=T)
# Cleaning down the data table:
d <- df[,list(ba=ba,nba=nba,bna=bna,nbna=nbna,
              vspeak=verifiedSpeaker,vreply=verifiedReplier,
              sid=speakerId,rid=replierId,category=category,
              pyalign=alignment,numUtterances=numUtterances),]

smoothalign <- function(df,sm,align="logodds") {
  if (align=="logodds") {
    return(log(df$ba+sm)-log(df$ba+df$nba+2*sm)-log(df$bna+sm)+log(df$bna+df$nbna+2*sm))
  } else if (align=="subodds") {
    return((df$ba+sm)/(df$ba+df$nba+2*sm)-(df$bna+sm)/(df$bna+df$nbna+2*sm))
  } else if (align=="logdnm") {
    return(log(df$ba+sm)-log(df$ba+df$nba+2*sm)-log(df$bna+df$ba+sm)+log(df$nba+df$ba+df$bna+df$nbna+2*sm))
  } else if (align=="subdnm") {
    return((df$ba+sm)/(df$ba+df$nba+2*sm)-(df$bna+df$ba+sm)/(df$nba+df$ba+df$bna+df$nbna+2*sm))
  } else {
    stop("Invalid alignment type.")
  }
} 

d$lo1 <- smoothalign(d,1,"logodds")
d$sd0 <- smoothalign(d,0,"subdnm")

cutoff = 10

d2 <- d %>%
  filter(vreply==F,(ba+nba)>=cutoff,(bna+nbna)>=cutoff) %>%
  group_by(vspeak,category) %>%
  summarize(base=mean(ba==0),base2=mean((2*ba+nba+bna)/(2*(ba+nba+bna+nbna))),Ours=mean(lo1),DNM=mean(sd0)) %>%
  gather(alignment,mean,Ours,DNM)

ggplot(d2,aes(x=vspeak,y=mean,color=base,label=category)) + geom_violin() + geom_text(position=position_jitter(w=0.2),size=4) + labs(title=paste("Non-verified repliers' alignments\naggregated by marker (Cutoff=",cutoff,")",sep=''),x="Speaker verification",y="Mean alignment",color="Speaker-replier\npairs using\nthe marker") + facet_wrap(~ alignment,scales="free") + theme_grey()

ggplot(d2[alignment=='Ours',],aes(x=base,y=mean,color=vspeak)) + geom_point() + geom_smooth(method="loess")

ggplot(d2[alignment=='Ours',],aes(x=vspeak,y=mean)) + geom_violin()
t.test(filter(d2, alignment=="Ours")$mean~filter(d2, alignment=="Ours")$vspeak)

```

*** Discourse Categories ***

```{r}
df <- fread('discourse_results.csv', header=T)
d <- df %>%
  filter(alignment > 0)

ggplot(d, aes(x=msgType, y=alignment)) + geom_violin() + facet_wrap(verifiedSpeaker~verifiedReplier)

```

