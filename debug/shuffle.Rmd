---
title: "shuffle"
output: pdf_document
---

Let's shuffle replies and replyUserIds

```{r}

library(data.table)
library(bit64)
library(dplyr)
library(ggplot2)
library(tidyr)


df <- fread('shuffled/shuffleReplyMarkersAndReplyUserId.csvFTTT', header=T)

# Cleaning down the data table:
d <- df[,list(ba=ba,nba=nba,bna=bna,nbna=nbna,
              vspeak=verifiedSpeaker,vreply=verifiedReplier,
              sid=speakerId,rid=replierId,category=category,
              pyalign=alignment,numUtterances=numUtterances),]

smoothalign <- function(df,sm,align="logodds") {
  if (align=="logodds") {
    return(log(df$ba+sm)-log(df$ba+df$nba+2*sm)-log(df$bna+sm)+log(df$bna+df$nbna+2*sm))
  } else if (align=="subodds") {
    return((df$ba+sm)/(df$ba+df$nba+2*sm)-(df$bna+sm)/(df$bna+df$nbna+2*sm))
  } else if (align=="logdnm") {
    return(log(df$ba+sm)-log(df$ba+df$nba+2*sm)-log(df$bna+df$ba+sm)+log(df$nba+df$ba+df$bna+df$nbna+2*sm))
  } else if (align=="subdnm") {
    return((df$ba+sm)/(df$ba+df$nba+2*sm)-(df$bna+df$ba+sm)/(df$nba+df$ba+df$bna+df$nbna+2*sm))
  } else {
    stop("Invalid alignment type.")
  }
} 

d$lo1 <- smoothalign(d,1,"logodds")
d$sd0 <- smoothalign(d,0,"subdnm")

cutoff = 5

d2 <- d %>%
  #filter(vreply==F,(ba+nba)>=cutoff,(bna+nbna)>=cutoff) %>%
  group_by(vspeak,category,vreply) %>%
  summarize(base=mean((2*ba+nba+bna)/(2*(ba+nba+bna+nbna))),Ours=mean(lo1),DNM=mean(sd0)) %>%
  gather(alignment,mean,Ours,DNM)

ggplot(d2,aes(x=vspeak,y=mean,color=base,label=category)) + geom_violin() + geom_text(position=position_jitter(w=0.2),size=4) + labs(title=paste("Non-verified repliers' alignments\naggregated by marker (Cutoff=",cutoff,")",sep=''),x="Speaker verification",y="Mean alignment",color="Speaker-replier\npairs using\nthe marker") + facet_wrap(~ alignment,scales="free") + theme_grey()

ggplot(d2[alignment=='Ours',],aes(x=base,y=mean,color=vspeak)) + geom_point()

ggplot(d2[alignment=='Ours',],aes(x=vreply,y=mean)) + geom_violin()
t.test(filter(d2, alignment=="Ours")$mean~filter(d2, alignment=="Ours")$vreply)

```